<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Sage</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
    <div id="wrapper">
        <div class="container">
            <header id="header">
            <div class="header-content">
                <div>
                    <div class="index-header" style="position: relative;">
                        <div class="index-title-row">
                            <img src="{{ url_for('static', filename='page_sage_logo.png') }}" alt="Page Sage Logo" class="index-logo" />
                            <h1 id="indexName" class="index-name-clickable" onclick="showDatabaseSwitcher()">Create and manage your book index offline</h1>
                        </div>

                        <!-- Database Switcher Dropdown (hidden by default) -->
                        <div id="databaseSwitcher" class="database-switcher" style="display: none;">
                            <div class="database-list">
                                <h3>Switch Index</h3>
                                <ul>
                                    <!-- Populated dynamically via JavaScript -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hamburger Menu Button -->
            <nav id="headerNav">
                <ul>
                    <li><a href="#menu" aria-label="Menu"><span class="sr-only">Menu</span></a></li>
                </ul>
            </nav>
        </header>

        <!-- Tab Navigation -->
        <div style="text-align: center;">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('add')"><span>Add Entry</span></button>
                <button class="tab-button" onclick="switchTab('view')"><span>View Index</span></button>
                <button class="tab-button" onclick="switchTab('progress')"><span>My Progress</span></button>
                <button class="tab-button" onclick="switchTab('books')"><span>Books</span></button>
                <button class="tab-button" onclick="switchTab('tools')"><span>Tools</span></button>
                <button class="tab-button" onclick="switchTab('settings')"><span>Settings</span></button>
            </div>
        </div>

        <!-- Add Entry Tab -->
        <div id="tab-add" class="tab-content active">
        <div class="card">
            <div class="toolbar">
                <h2>Add New Entry</h2>
            </div>
            <div id="message" class="message"></div>
            <form id="addForm">
                <div class="form-row" style="margin-bottom: 0.5rem;">
                    <div class="form-group form-group-term" style="margin-bottom: 1em;">
                        <label for="term">Term:</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="term" name="term" required
                                   placeholder="e.g., machine learning"
                                   autocomplete="off">
                            <div id="autocomplete-list" class="autocomplete-items"></div>
                        </div>
                        <small style="display: block; margin-top: 0.25rem;">Leave blank to add only a note</small>
                    </div>

                    <div class="form-group form-group-ref" style="margin-bottom: 0;">
                        <label>Reference:</label>
                        <div class="reference-inputs">
                            <select id="book" name="book" class="ref-input book-select">
                                <option value="">Book</option>
                            </select>
                            <span class="ref-separator">:</span>
                            <input type="text" id="page" name="page"
                                   placeholder="Start" class="ref-input" style="width: 65px;"
                                   pattern="[0-9]*" inputmode="numeric">
                            <span class="ref-separator">-</span>
                            <input type="text" id="pageEnd" name="pageEnd"
                                   placeholder="End" class="ref-input" style="width: 65px;"
                                   pattern="[0-9]*" inputmode="numeric">
                        </div>
                        <small style="display: block; margin-top: 0.25rem;">Select the book, start and end page for this term</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes" name="notes" rows="3"
                              placeholder="Enter notes about this term..."></textarea>
                    <small>Notes are associated with the term, not specific page references</small>
                </div>

                <button type="submit" class="btn btn-primary">Add Entry</button>
            </form>
        </div>

        <div class="card">
            <h2 style="font-size: 1.3rem;">Recently Added Terms</h2>
            <div id="recentEntriesList" class="recent-entries-list">
                <p class="loading">Loading...</p>
            </div>
            <div id="recentEntriesShowMore" style="display: none; margin-top: 0.5rem;">
                <button class="btn btn-secondary" onclick="showMoreRecentEntries()" style="width: 100%; padding: 0.35rem;">
                    Show More
                </button>
            </div>
        </div>
        </div>

        <!-- View References Tab -->
        <div id="tab-view" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h2>Index References</h2>
            </div>
            <div id="viewEntriesMessage" class="message"></div>

            <!-- Filter Bar -->
            <div class="filter-bar" style="flex-wrap: wrap; border-bottom: none; margin-bottom: 0; padding-bottom: 0.5rem;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="bookFilter">Filter by Book:</label>
                    <select id="bookFilter" class="ref-input book-select" style="min-width: 150px;">
                        <option value="">All Books</option>
                    </select>
                </div>
                <input type="text" id="searchInput" placeholder="Search terms and notes..."
                       class="search-box" style="min-width: 300px; flex: 1;">
                <button onclick="refreshEntries()" class="btn btn-secondary">Refresh</button>
                <button onclick="quickExport()" class="btn btn-primary" title="Export Index as PDF">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; margin: 0; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem;">
                <input type="checkbox" id="showNotesCheckbox" checked onchange="toggleNotesDisplay()">
                <span>Show Notes</span>
            </label>

            <!-- Letter Navigation -->
            <div id="letterNav" class="letter-nav">
                <!-- Will be populated by JavaScript -->
            </div>

            <div id="entriesList" class="entries-list">
                <p class="loading">Loading...</p>
            </div>
            <div id="stats" class="stats"></div>
        </div>
        </div>

        <!-- Progress Tab -->
        <div id="tab-progress" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h2>Indexing Progress</h2>
            </div>
            <p style="margin-bottom: 1em;">Track your indexing completeness by identifying pages that are not yet associated with a reference. This feature requires a page count to be set for each book in the <strong>Books</strong> tab. Click on missing pages to create a reference or exclude them from the analysis.</p>

            <!-- Summary Stats -->
            <div class="progress-summary-stats">
                <div class="progress-stat-card">
                    <div class="progress-stat-value" id="statTotalBooks">-</div>
                    <div class="progress-stat-label">Total Books</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value" id="statTotalPages">-</div>
                    <div class="progress-stat-label">Total Pages</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value" id="statIndexedPages">-</div>
                    <div class="progress-stat-label">Pages Indexed</div>
                </div>
                <div class="progress-stat-card">
                    <div class="progress-stat-value" id="statOverallProgress">-</div>
                    <div class="progress-stat-label">Overall Progress</div>
                </div>
            </div>

            <!-- Progress Statistics Collapsible Card -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleProgressSection('charts')">
                    <span class="collapse-icon">▼</span> Progress Statistics
                </h3>
                <div id="chartsContainer" class="collapsible-container">
                    <!-- Charts Grid - Row 1 -->
                    <div class="progress-charts-grid">
                        <div class="progress-chart-card">
                            <h3>Overall Progress</h3>
                            <p>Distribution of indexed, excluded, and gap pages</p>
                            <div class="progress-chart-container" id="progressDonutChart"></div>
                        </div>
                        <div class="progress-chart-card">
                            <h3>Book Completion Comparison</h3>
                            <p>Breakdown of indexed, excluded, and gap pages for each book</p>
                            <div class="progress-chart-container" id="progressStackedBarChart"></div>
                        </div>
                    </div>

                    <!-- Charts Grid - Row 2 -->
                    <div class="progress-charts-grid">
                        <div class="progress-chart-card">
                            <h3>Term Density by Book</h3>
                            <p>Terms indexed per 100 pages. Lower density suggests the book may need more indexing.</p>
                            <div class="progress-chart-container" id="progressDensityChart"></div>
                        </div>
                        <div class="progress-chart-card">
                            <h3>Gap Distribution</h3>
                            <p>Number of gap pages remaining in each book</p>
                            <div class="progress-chart-container" id="progressTreemapChart"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gapAnalysisResults" class="gap-results"></div>
        </div>
        </div>

        <!-- Books Tab -->
        <div id="tab-books" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h2>Book Management</h2>
            </div>
            <div id="bookManagementMessage" class="message"></div>
            <p style="margin-bottom: 1em;">Manage the books in your index. Add custom metadata like author, publisher, and theme.</p>

            <div id="booksList" class="books-list"></div>

            <h3>Add New Book</h3>
            <div id="addBookMessage" class="message"></div>
            <div class="book-form">
                <div class="form-group">
                    <label for="newBookName">Book Name:</label>
                    <input type="text" id="newBookName" placeholder="Volume 1">
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label for="newBookNumber">Book Number:</label>
                        <input type="text" id="newBookNumber" placeholder="1" pattern="[0-9]*" inputmode="numeric">
                    </div>
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label for="newBookPages">Page Count:</label>
                        <input type="text" id="newBookPages" placeholder="500" pattern="[0-9]*" inputmode="numeric">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addBook()" style="margin-top: 1rem;">Add Book</button>
            </div>
        </div>
        </div>

        <!-- Tools Tab -->
        <div id="tab-tools" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h2>Tools</h2>
            </div>
            <p style="margin-bottom: 1em;">Export your index, import data from CSV, generate AI-powered notes, or review with flashcards.</p>

            <!-- Export Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleToolsSection('export')">
                    <span id="exportToggle">▶</span> Export
                </h3>
                <div id="exportContainer" class="collapsible-container collapsed">
                    <p style="margin-top: 1rem;">Download your index or notes:</p>
                    <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-top: 0.5rem;">
                        <select id="exportType" class="filter-select" style="flex: 0 0 100px;">
                            <option value="index">Index</option>
                            <option value="notes">Notes</option>
                        </select>
                        <select id="exportBook" class="filter-select" style="flex: 0 0 160px;">
                            <option value="">All Books</option>
                            <!-- Populated dynamically -->
                        </select>
                        <select id="exportFormat" class="filter-select" style="flex: 0 0 130px;">
                            <option value="pdf">PDF</option>
                            <option value="plain">Plain Text</option>
                            <option value="markdown">Markdown</option>
                            <option value="latex">LaTeX</option>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                        </select>
                        <button onclick="doExport()" class="btn btn-primary">
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Import Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleToolsSection('import')">
                    <span id="importToggle">▶</span> Import from CSV
                </h3>
                <div id="importContainer" class="collapsible-container collapsed">
                    <div id="importMessage" class="message"></div>

                    <!-- Import Tabs -->
                    <div class="import-tabs">
                        <button class="import-tab active" onclick="switchImportTab('references')">Import References</button>
                        <button class="import-tab" onclick="switchImportTab('notes')">Import Notes</button>
                    </div>

                    <!-- Import References Tab -->
                    <div id="importReferencesTab" class="import-tab-content active">
                        <p>Paste your CSV data below. Each line can have multiple references for the same term. <a href="#" onclick="showCsvHelpModal(); return false;">Click here for more help.</a></p>
                        <form id="importForm">
                            <div class="form-group">
                                <label for="csvData">CSV Data:</label>
                                <textarea id="csvData" name="csvData" rows="12"
                                          placeholder="Paste CSV data here, one entry per line&#10;Format: term,reference1,reference2,...&#10;&#10;Examples:&#10;machine learning,1:42&#10;neural networks,2:15-18,2:25,3:10&#10;deep learning,1:50,1:75-80"></textarea>
                            </div>
                            <small style="display: block; margin-bottom: 1rem;">Only new references are added. Existing references for a term are skipped.</small>
                            <button type="submit" class="btn btn-primary">Import References</button>
                        </form>
                    </div>

                    <!-- Import Notes Tab -->
                    <div id="importNotesTab" class="import-tab-content">
                        <p>Import notes for terms. Each line should have a term and its note.</p>
                        <form id="importNotesForm">
                            <div class="form-group">
                                <label for="csvNotesData">CSV Data:</label>
                                <textarea id="csvNotesData" name="csvNotesData" rows="12"
                                          placeholder="Paste CSV data here, one entry per line&#10;Format: term,note&#10;&#10;Examples:&#10;machine learning,A subset of AI that learns from data&#10;neural networks,Inspired by biological neural networks&#10;deep learning,Uses multiple layers of neural networks"></textarea>
                            </div>
                            <small style="display: block; margin-bottom: 1rem;">Importing a note for an existing term will overwrite the previous note. New terms are created if they don't exist.</small>
                            <button type="submit" class="btn btn-primary">Import Notes</button>
                        </form>
                    </div>

                    <div id="importResults" class="import-results"></div>
                </div>
            </div>

            <!-- AI Term Enrichment Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleToolsSection('ai')">
                    <span id="aiToggle">▶</span> AI Term Enrichment
                </h3>
                <div id="aiContainer" class="collapsible-container collapsed">
                    <p>Generate brief descriptions for terms without notes using AI. <a href="#" onclick="event.preventDefault(); showAiHelpModal();">Learn more</a></p>

                    <div id="aiMessage" class="message" style="margin-bottom: 1rem;"></div>

                    <div class="ai-actions" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="copyAiPrompt()">Copy AI Prompt</button>
                        <button type="button" class="btn btn-primary" onclick="enrichTermsWithApi()" id="enrichApiBtn" style="display: none;">Enrich with API</button>
                    </div>
                </div>
            </div>

            <!-- Study Mode Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleToolsSection('study')">
                    <span id="studyToggle">▶</span> Study Mode
                </h3>
                <div id="studyContainer" class="collapsible-container collapsed">
                    <p>Review your terms with flashcards. Click the card to reveal the notes.</p>

                    <div id="studySetup">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label for="studyFilter">Filter by:</label>
                            <select id="studyFilter" class="ref-input" style="width: 100%;">
                                <option value="all">All terms with notes</option>
                                <option value="book">Specific book</option>
                            </select>
                        </div>
                        <div id="studyBookFilter" class="form-group" style="margin-bottom: 1rem; display: none;">
                            <label for="studyBookSelect">Book:</label>
                            <select id="studyBookSelect" class="ref-input" style="width: 100%;"></select>
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="studyShuffle" checked>
                                <span>Shuffle cards</span>
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="startStudyMode()">Start Study Session</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Study Mode Overlay -->
        <div id="studyOverlay" class="study-overlay">
            <div class="study-session-container">
                <div class="study-header">
                    <div class="study-progress">
                        <span id="studyProgress">0 / 0</span>
                    </div>
                    <button type="button" class="btn-end-session" onclick="endStudyMode()" title="End Session">&times;</button>
                </div>

                <div class="flashcard-wrapper">
                    <div class="flashcard" id="flashcard" onclick="flipFlashcard()">
                        <div class="flashcard-inner" id="flashcardInner">
                            <div class="flashcard-front">
                                <div class="flashcard-term" id="flashcardTerm"></div>
                                <div class="flashcard-hint">Click to reveal</div>
                            </div>
                            <div class="flashcard-back">
                                <div class="flashcard-term" id="flashcardTermBack"></div>
                                <div class="flashcard-notes" id="flashcardNotes"></div>
                                <div class="flashcard-refs" id="flashcardRefs"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="study-controls">
                    <button type="button" class="btn btn-secondary" onclick="prevFlashcard()" id="prevCardBtn">Previous</button>
                    <button type="button" class="btn btn-primary" onclick="nextFlashcard()" id="nextCardBtn">Next</button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="tab-settings" class="tab-content">
        <div class="card">
            <div class="toolbar">
                <h2>Settings</h2>
            </div>
            <p style="margin-bottom: 1em;">Customize your index name, appearance, AI features, and manage your databases.</p>

            <!-- Index Settings Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleSettingsSection('indexSettings')">
                    <span id="indexSettingsToggle">▶</span> Index Settings
                </h3>
                <div id="indexSettingsContainer" class="collapsible-container collapsed">
                    <p class="settings-help">Update index name and add custom metadata like author, publisher, or edition to your index. Click a property to edit, drag to reorder.</p>
                    <div id="indexSettingsMessage" class="message"></div>
                    <div class="form-group">
                        <label for="settingsIndexName">Index Name:</label>
                        <input type="text" id="settingsIndexName" placeholder="My Book Index">
                    </div>

                    <div class="custom-properties-form" style="margin-top: 1.5rem;">
                        <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group" style="flex: 1; margin: 0;">
                                <label for="propertyName">Metadata:</label>
                                <input type="text" id="propertyName" placeholder="e.g., Author, Publisher, Edition">
                            </div>
                            <div class="form-group" style="flex: 1; margin: 0;">
                                <label for="propertyValue">Value:</label>
                                <input type="text" id="propertyValue" placeholder="e.g., John Smith">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveAllSettings()">Save</button>

                    <div id="customPropertiesTable" class="custom-properties-table" style="margin-top: 1rem;">
                        <!-- Properties will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Appearance Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleSettingsSection('appearance')">
                    <span id="appearanceToggle">▶</span> Appearance
                </h3>
                <div id="appearanceContainer" class="collapsible-container collapsed">
                    <p class="settings-help">Choose an accent color for buttons, links, and highlights.</p>
                    <div id="colorSchemeMessage" class="message"></div>
                    <div class="form-group">
                        <label for="colorScheme">Accent Color:</label>
                        <select id="colorScheme" class="color-scheme-select" onchange="changeColorScheme()">
                            <option value="#87AE73" data-name="Sage" style="background-color: #87AE73;">Sage</option>
                            <option value="#9ca3af" data-name="Slate Grey" style="background-color: #9ca3af;">Slate Grey</option>
                            <option value="#f2849e" data-name="Coral Pink" style="background-color: #f2849e;">Coral Pink</option>
                            <option value="#84f2de" data-name="Teal" style="background-color: #84f2de;">Teal</option>
                            <option value="#c9a961" data-name="Gold" style="background-color: #c9a961;">Gold</option>
                            <option value="#84c4f2" data-name="Blue" style="background-color: #84c4f2;">Blue</option>
                            <option value="#f2a063" data-name="Orange" style="background-color: #f2a063;">Orange</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Index Management Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleSettingsSection('indexManagement')">
                    <span id="indexManagementToggle">▶</span> Index Management
                </h3>
                <div id="indexManagementContainer" class="collapsible-container collapsed">
                    <p class="settings-help">Create, backup, import, or archive your indexes.</p>
                    <div class="form-group">
                        <label for="indexManagementAction">Action:</label>
                        <select id="indexManagementAction" class="ref-input book-select" style="min-width: 200px;">
                            <option value="">Select an action...</option>
                            <option value="create">Create New Index</option>
                            <option value="backup">Backup Index</option>
                            <option value="import">Import Index</option>
                            <option value="archive">Archive Index</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="executeIndexManagementAction()">Go</button>
                </div>
            </div>

            <!-- AI Features Section -->
            <div class="tool-card">
                <h3 class="collapsible-heading" onclick="toggleSettingsSection('aiFeatures')">
                    <span id="aiFeaturesToggle">▶</span> AI Features
                </h3>
                <div id="aiFeaturesContainer" class="collapsible-container collapsed">
                    <p class="settings-help">Configure AI to auto generate study notes.</p>
                    <div id="aiSettingsMessage" class="message"></div>

                    <div class="form-group">
                        <label for="aiProvider">AI Provider:</label>
                        <select id="aiProvider" class="ref-input" style="width: 100%;">
                            <option value="">-- Select Provider --</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="openai">OpenAI (ChatGPT)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="aiApiKey">API Key:</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="password" id="aiApiKey" class="ref-input" style="flex: 1;" placeholder="Enter your API key">
                            <button type="button" class="btn btn-secondary" onclick="validateAiApiKey()" id="validateKeyBtn">Validate</button>
                        </div>
                        <small id="apiKeyValidationStatus" style="display: none; margin-top: 0.25rem;"></small>
                    </div>

                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="enableAiFeatures" disabled>
                        <span>Enable AI features</span>
                    </label>
                    <small id="enableAiHint" style="display: block; margin-bottom: 1rem;">To enable automated AI features you must first save an API key.</small>

                    <div style="display: flex; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="saveAiSettings()">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="clearAiApiKey()">Clear API Key</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Reference</h2>
                    <button class="modal-close" onclick="closeEditModal()">&times;</button>
                </div>
                <form id="editForm">
                    <div class="form-group">
                        <label for="editTerm">Term:</label>
                        <input type="text" id="editTerm" name="editTerm">
                    </div>

                    <input type="hidden" id="editOldReference" name="editOldReference">

                    <div class="form-group">
                        <label>Updated Reference:</label>
                        <div class="reference-inputs">
                            <select id="editBook" name="editBook" required class="ref-input book-select">
                                <option value="">Book</option>
                            </select>
                            <span class="ref-separator">:</span>
                            <input type="text" id="editPage" name="editPage" required
                                   placeholder="Start" class="ref-input" style="width: 65px;"
                                   pattern="[0-9]*" inputmode="numeric">
                            <span class="ref-separator">-</span>
                            <input type="text" id="editPageEnd" name="editPageEnd"
                                   placeholder="End" class="ref-input" style="width: 65px;"
                                   pattern="[0-9]*" inputmode="numeric">
                        </div>
                        <small>Format: book:page or book:start-end</small>
                    </div>

                    <div class="form-group">
                        <label for="editNotes">Notes:</label>
                        <textarea id="editNotes" name="editNotes" rows="4"
                                  placeholder="Enter notes about this term..."></textarea>
                        <small>Notes are associated with the term, not specific page references</small>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-danger" onclick="deleteReferenceFromModal()">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Notes Modal -->
        <div id="editNotesModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Notes</h2>
                    <button class="modal-close" onclick="closeEditNotesModal()">&times;</button>
                </div>
                <form id="editNotesForm">
                    <div class="form-group">
                        <label for="editNotesTerm">Term:</label>
                        <input type="text" id="editNotesTerm" name="editNotesTerm" readonly>
                    </div>

                    <div class="form-group">
                        <label for="editNotesText">Notes:</label>
                        <textarea id="editNotesText" name="editNotesText" rows="8"
                                  placeholder="Enter notes about this term..."></textarea>
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Update</button>
                        <button type="button" class="btn btn-danger" onclick="deleteNotesFromModal()">Delete Notes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditNotesModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Gap Range Action Modal -->
        <div id="gapActionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="gapActionTitle">Missing Pages</h2>
                    <button class="modal-close" onclick="closeGapActionModal()">&times;</button>
                </div>
                <div style="padding: 1rem 0;">
                    <p id="gapActionMessage" style="margin-bottom: 1.5rem; color: var(--text-color);"></p>
                    <div class="modal-actions" style="justify-content: center; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="gapActionCreateReference()">
                            Create Reference
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="gapActionExclude()">
                            Exclude from Analysis
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeGapActionModal()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Re-include Exclusion Modal -->
        <div id="reincludeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="reincludeTitle">Re-include Pages</h2>
                    <button class="modal-close" onclick="closeReincludeModal()">&times;</button>
                </div>
                <div style="padding: 1rem 0;">
                    <p id="reincludeMessage" style="margin-bottom: 1.5rem; color: var(--text-color);"></p>
                    <div class="modal-actions" style="justify-content: center; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="confirmReinclude()">
                            ✓ Re-include Pages
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeReincludeModal()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Book Modal -->
        <div id="editBookModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Book</h2>
                    <button class="modal-close" onclick="closeEditBookModal()">&times;</button>
                </div>
                <form id="editBookForm">
                    <input type="hidden" id="editBookOldNumber" name="editBookOldNumber">

                    <div class="form-group">
                        <label for="editBookNumber">Book Number:</label>
                        <input type="text" id="editBookNumber" name="editBookNumber" required pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="form-group">
                        <label for="editBookName">Book Name:</label>
                        <input type="text" id="editBookName" name="editBookName" required>
                    </div>

                    <div class="form-group">
                        <label for="editBookPages">Page Count:</label>
                        <input type="text" id="editBookPages" name="editBookPages"
                               pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Update Book</button>
                        <button type="button" class="btn btn-danger" onclick="deleteBookFromModal()">Delete Book</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditBookModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Book Modal -->
        <div id="addBookModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Book</h2>
                    <button class="modal-close" onclick="closeAddBookModal()">&times;</button>
                </div>
                <form id="addBookModalForm">
                    <input type="hidden" id="addBookSource" name="addBookSource">

                    <div class="form-group">
                        <label for="addBookModalNumber">Book Number:</label>
                        <input type="text" id="addBookModalNumber" name="addBookModalNumber" required pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="form-group">
                        <label for="addBookModalName">Book Name:</label>
                        <input type="text" id="addBookModalName" name="addBookModalName" required>
                    </div>

                    <div class="form-group">
                        <label for="addBookModalPages">Page Count:</label>
                        <input type="text" id="addBookModalPages" name="addBookModalPages"
                               pattern="[0-9]*" inputmode="numeric">
                    </div>

                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Add Book</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddBookModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- About Modal -->
        <div id="aboutModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>About Page Sage</h2>
                    <button class="modal-close" onclick="closeAboutModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <p style="font-size: 1.2em; margin-bottom: 0.5em;"><strong>Page Sage</strong></p>
                    <p style="font-style: italic; color: var(--secondary-color); margin-bottom: 1em;">Your wise study companion</p>

                    <p style="margin-bottom: 1.5em; color: var(--primary-color);">
                        <strong>Version:</strong> 1.0 &nbsp;|&nbsp; <strong>Year:</strong> 2026 &nbsp;|&nbsp; <strong>License:</strong> AGPL-3.0
                    </p>

                    <h3 style="margin-top: 1.5em; margin-bottom: 0.75em; color: var(--text-color);">The Smart Study Index for Open-Book Exams</h3>
                    <p style="margin-bottom: 1em;">
                        Open-book exams aren't tests of memory—they're tests of <strong>preparation and retrieval speed</strong>. The students who pass aren't the ones who memorized everything; they're the ones who built systems to find information in seconds, not minutes.
                    </p>
                    <p style="margin-bottom: 1.5em;">
                        Page Sage is a complete index management system that covers every phase: creation, organization, search, progress tracking, study mode, and professional export.
                    </p>

                    <h3 style="margin-top: 1.5em; margin-bottom: 0.75em; color: var(--text-color);">Features</h3>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1.5em;">
                        <li style="margin-bottom: 0.5em;"><strong>Multi-book Index Management</strong> - Track multiple books with custom metadata (author, publisher, edition)</li>
                        <li style="margin-bottom: 0.5em;"><strong>Term Tracking with Notes</strong> - Add study notes to any term for flashcard-based review</li>
                        <li style="margin-bottom: 0.5em;"><strong>Gap Analysis</strong> - Identify unindexed pages and exclude pages from analysis (front matter, etc.)</li>
                        <li style="margin-bottom: 0.5em;"><strong>Multiple Export Formats</strong> - Export to LaTeX, PDF, Markdown, or plain text</li>
                        <li style="margin-bottom: 0.5em;"><strong>Progress Charts</strong> - Visual dashboards showing overall progress, term density by book, book completion comparison, and gap distribution</li>
						<li style="margin-bottom: 0.5em;"><strong>Study Mode</strong> - Flashcard-based review with keyboard shortcuts</li>
                        <li style="margin-bottom: 0.5em;"><strong>AI Integration</strong> - Optional AI-powered note generation (requires API key)</li>
                        <li style="margin-bottom: 0.5em;"><strong>Multiple Indexes</strong> - Create, switch between, backup, and archive separate indexes</li>
                        <li style="margin-bottom: 0.5em;"><strong>Customizable Appearance</strong> - Choose from multiple accent colors</li>
                        <li style="margin-bottom: 0.5em;"><strong>Works Completely Offline</strong> - No internet required, no tracking, no cloud dependencies</li>
                    </ul>

                    <h3 style="margin-top: 1.5em; margin-bottom: 0.75em; color: var(--text-color);">Technology</h3>
                    <p style="margin-bottom: 1em;">
                        Built with Python Flask, SQLite, vanilla JavaScript, and ApexCharts for progress visualizations. No frameworks, no tracking, no cloud dependencies.
                    </p>

                    <h3 style="margin-top: 1.5em; margin-bottom: 0.75em; color: var(--text-color);">Created For</h3>
                    <p style="margin-bottom: 1em;">
                        SANS students, GIAC certification candidates, and anyone facing open-book exams with massive reference materials.
                    </p>

                    <p style="margin-top: 1.5em; font-size: 0.9em; color: var(--secondary-color);">
                        Template design by <a href="http://html5up.net" target="_blank" rel="noopener" style="color: var(--primary-color);">HTML5 UP</a>
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAboutModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2>Help & Keyboard Shortcuts</h2>
                    <button class="modal-close" onclick="closeHelpModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <h3 style="margin-top: 0; margin-bottom: 1em; color: var(--text-color);">Keyboard Shortcuts</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1.5em;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="text-align: left; padding: 0.75em 1em; font-weight: 700;">Key</th>
                                <th style="text-align: left; padding: 0.75em 1em; font-weight: 700;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">1-6</code></td>
                                <td style="padding: 0.75em 1em;">Navigate to tabs (1=Add Entry, 2=View References, 3=Progress, 4=Books, 5=Tools, 6=Settings)</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">/</code></td>
                                <td style="padding: 0.75em 1em;">Focus search or term input</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">Esc</code></td>
                                <td style="padding: 0.75em 1em;">Close modals or hamburger menu</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4 style="margin-top: 0; margin-bottom: 0.75em; color: var(--text-color);">Study Mode Shortcuts</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2em;">
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">Space</code></td>
                                <td style="padding: 0.5em 1em;">Flip flashcard</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">N</code></td>
                                <td style="padding: 0.5em 1em;">Next flashcard</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">P</code></td>
                                <td style="padding: 0.5em 1em;">Previous flashcard</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.5em 1em;"><code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">Esc</code></td>
                                <td style="padding: 0.5em 1em;">End study session</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="margin-top: 1.5em; margin-bottom: 1em; color: var(--text-color);">Tips</h3>
                    <ul style="list-style: disc; padding-left: 1.5em;">
                        <li style="margin-bottom: 0.5em;">Use the autocomplete on the term field to quickly reference existing terms</li>
                        <li style="margin-bottom: 0.5em;">Click references to edit them directly from the View References tab</li>
                        <li style="margin-bottom: 0.5em;">Set page counts for books to enable progress tracking and gap analysis</li>
                        <li style="margin-bottom: 0.5em;">Backup your index regularly from Settings → Index Management</li>
                        <li style="margin-bottom: 0.5em;">Click on chart elements to see full book names in tooltips</li>
                    </ul>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeHelpModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- How to Use Modal -->
        <div id="howToUseModal" class="modal">
            <div class="modal-content" style="max-width: 750px;">
                <div class="modal-header">
                    <h2>Getting Started with Page Sage</h2>
                    <button class="modal-close" onclick="closeHowToUseModal()">&times;</button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <h3 style="margin-top: 0; margin-bottom: 1em; color: var(--text-color);">The Open-Book Exam Challenge</h3>
                    <p style="margin-bottom: 1em;">
                        You're sitting for your certification exam. The good news? It's open book—you can bring all your course materials, notes, and references. The bad news? You have limited time to answer challenging questions, and your books contain thousands of pages. Sure you studied, but you will want to double-check your answer, right?
                    </p>
                    <p style="margin-bottom: 1.5em;">
                        <strong>The solution:</strong> Build an index whilst studying that lets you find information in seconds, not minutes. Page Sage helps you create, manage, and export a professional study index.
                    </p>

                    <h3 style="margin-top: 1.5em; margin-bottom: 1em; color: var(--text-color);">Quick Start Guide</h3>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">1. Add Books</h4>
                    <p style="margin-bottom: 1em;">Go to the <strong>Books</strong> tab and add your textbooks with their numbers, page counts, and custom metadata (author, publisher, etc.).</p>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">2. Create Index Entries</h4>
                    <p style="margin-bottom: 0.5em;">On the <strong>Add Entry</strong> tab, enter terms with book:page references. Add notes to help you remember key concepts.</p>
                    <p style="margin-bottom: 1em;">Use <strong>Tools → AI Term Enrichment</strong> to automatically generate study notes for your terms using Claude or ChatGPT.</p>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">Reference Format</h4>
                    <p style="margin-bottom: 0.5em;">References use the format <code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">book:page</code> or <code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">book:start-end</code> for page ranges.</p>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1em;">
                        <li><strong>Book</strong> – Select the book number from the dropdown</li>
                        <li><strong>Start</strong> – Enter the page number where the term appears</li>
                        <li><strong>End</strong> – For page ranges, enter the ending page (optional)</li>
                    </ul>
                    <p style="margin-bottom: 1em;">
                        <strong>Examples:</strong><br>
                        <code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">1:42</code> → Book 1, page 42<br>
                        <code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">2:15-18</code> → Book 2, pages 15 through 18<br>
                        <code style="background: var(--hover-color); padding: 0.2em 0.5em; border-radius: 3px;">3:100</code> → Book 3, page 100
                    </p>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">3. Track Progress</h4>
                    <p style="margin-bottom: 0.5em;">The <strong>My Progress</strong> tab shows visual charts of your indexing progress. Use gap analysis to identify unindexed pages.</p>
                    <p style="margin-bottom: 1em;"><strong>Page Exclusions:</strong> Some pages don't need indexing (front matter, blank pages, appendices). Click on a gap range in the progress view and select "Exclude" to mark these pages. Excluded pages won't count against your coverage percentage.</p>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">4. Study & Review</h4>
                    <p style="margin-bottom: 1em;">Use <strong>Tools → Study Mode</strong> to review your terms as flashcards before exam day.</p>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">5. Export Your Index</h4>
                    <p style="margin-bottom: 1.5em;">Use the <strong>Tools</strong> tab to export your index to PDF, LaTeX, Markdown, or plain text formats.</p>

                    <h3 style="margin-top: 1.5em; margin-bottom: 1em; color: var(--text-color);">Recommended Workflow</h3>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">During Initial Study</h4>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1em;">
                        <li>Use Page Sage during study sessions</li>
                        <li>When you encounter important terms, tools, or concepts: add them immediately</li>
                        <li>Add notes explaining key concepts for later review</li>
                        <li>Continue building your index as you study</li>
                    </ul>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">Mid-Study Progress Check</h4>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1em;">
                        <li>Open My Progress tab to see visual dashboards</li>
                        <li>Check which books have the lowest term density</li>
                        <li>Review gap analysis to find unindexed pages</li>
                        <li>Use Study Mode flashcards to test your recall</li>
                    </ul>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">Practice Tests</h4>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1em;">
                        <li>Take practice tests (timed, open-book)</li>
                        <li>Notice which terms you search for most</li>
                        <li>Add missing terms you struggled to find</li>
                    </ul>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">Final Prep</h4>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1em;">
                        <li>Export to PDF and generate a professional index</li>
                        <li>Print and organize your index</li>
                        <li>Run through Study Mode one final time</li>
                        <li>Backup your database for future reference</li>
                    </ul>

                    <h4 style="margin-top: 1em; margin-bottom: 0.5em; font-size: 1em; color: var(--secondary-color);">Exam Day</h4>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1.5em;">
                        <li>Bring your printed Page Sage export</li>
                        <li>4-second lookup times instead of 2-minute searches</li>
                        <li>More time for analysis, less time searching</li>
                    </ul>

                    <p style="margin-top: 1.5em; padding: 1em; background: var(--hover-color); border-radius: 8px; text-align: center;">
                        <strong>Your exam success doesn't depend on memorization—it depends on preparation and retrieval speed.</strong>
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeHowToUseModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- CLI Reference Modal -->
        <div id="cliModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2>CLI Reference</h2>
                    <button class="modal-close" onclick="closeCliModal()">&times;</button>
                </div>
                <div class="modal-body" style="font-family: 'Source Sans Pro', monospace; max-height: 70vh; overflow-y: auto;">
                    <pre style="background: var(--bg-color); padding: 1.5em; border-radius: 8px; overflow-x: auto; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
<strong>NAME</strong>
    index_cli.py - Command line interface for Page Sage

<strong>SYNOPSIS</strong>
    python index_cli.py [-d DATABASE] COMMAND [OPTIONS]

<strong>DESCRIPTION</strong>
    A command line tool for creating and managing book indexes offline.
    Use this tool for scripting, automation, or when you prefer working
    in the terminal.

<strong>GLOBAL OPTIONS</strong>
    -d, --database FILE
        Specify the database file to use (default: book_index.db)

<strong>COMMANDS</strong>

    <strong style="color: var(--secondary-color);">add</strong> TERM REFERENCE
        Add a new index entry.

        Arguments:
            TERM        The index term to add
            REFERENCE   Page reference in format book:page or book:start-end

        Examples:
            python index_cli.py add "machine learning" 1:42
            python index_cli.py add "neural networks" 2:15-18
            python index_cli.py add "deep learning" 1:50

    <strong style="color: var(--secondary-color);">list</strong>
        List all index entries grouped by letter.

        Example:
            python index_cli.py list

    <strong style="color: var(--secondary-color);">search</strong> PATTERN
        Search for entries matching a pattern.

        Arguments:
            PATTERN     Search pattern (case-insensitive)

        Examples:
            python index_cli.py search "learning"
            python index_cli.py search "network"

    <strong style="color: var(--secondary-color);">delete</strong> TERM [REFERENCE]
        Delete an entry or specific reference.

        Arguments:
            TERM        The term to delete
            REFERENCE   Optional: specific reference to delete
                       If omitted, deletes all references for the term

        Examples:
            python index_cli.py delete "old term" 1:10
            python index_cli.py delete "obsolete term"

    <strong style="color: var(--secondary-color);">update</strong> TERM OLD_REFERENCE NEW_REFERENCE
        Update an existing reference.

        Arguments:
            TERM            The term to update
            OLD_REFERENCE   Current reference value
            NEW_REFERENCE   New reference value

        Example:
            python index_cli.py update "machine learning" 1:42 1:45

    <strong style="color: var(--secondary-color);">export</strong> [-o OUTPUT] [-f FORMAT] [-t TITLE]
        Export the index to a file.

        Options:
            -o, --output FILE   Output filename (default: index.txt)
            -f, --format FMT    Output format: latex, plain, markdown, pdf
                               (default: latex)
            -t, --title TEXT    Index title (default: Index)

        Examples:
            python index_cli.py export -f pdf -o my_index.pdf
            python index_cli.py export -f latex -o index.tex -t "Study Guide"
            python index_cli.py export -f markdown -o index.md

<strong>REFERENCE FORMAT</strong>
    References must be in the format: book:page or book:start-end

    Examples:
        1:42        Book 1, page 42
        2:15-18     Book 2, pages 15 through 18
        3:100       Book 3, page 100

<strong>DATABASE</strong>
    By default, the CLI uses 'book_index.db' in the current directory.
    Use the -d option to specify a different database file.

    The same database can be used with both the CLI and web interface.

<strong>EXAMPLES</strong>
    # Create a new index and add entries
    python index_cli.py add "TCP/IP" 1:25-30
    python index_cli.py add "TCP/IP" 2:15
    python index_cli.py add "UDP protocol" 1:45

    # List all entries
    python index_cli.py list

    # Search for networking terms
    python index_cli.py search "protocol"

    # Export to PDF
    python index_cli.py export -f pdf -o network_index.pdf -t "Network Index"

    # Use a specific database
    python index_cli.py -d my_study.db add "Important topic" 1:100

<strong>SEE ALSO</strong>
    Web interface: python web_app.py
    GitHub: https://github.com/agraham46/PageSage
                    </pre>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCliModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- CSV Help Modal -->
        <div id="csvHelpModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>CSV Format Help</h2>
                    <button class="modal-close" onclick="closeCsvHelpModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1.5em;">Use this tool to bulk import term references from CSV-formatted data.</p>

                    <h3 style="margin-top: 0; margin-bottom: 1em; color: var(--text-color);">Format</h3>
                    <p style="margin-bottom: 1em;"><code style="background: #f5f5f5; padding: 0.2em 0.5em; border-radius: 3px;">term,reference1,reference2,...</code></p>

                    <p style="margin-bottom: 1em;">References can be:</p>
                    <ul style="list-style: disc; padding-left: 1.5em; margin-bottom: 1.5em;">
                        <li style="margin-bottom: 0.5em;"><code style="background: #f5f5f5; padding: 0.2em 0.5em; border-radius: 3px;">book:page</code> for single pages</li>
                        <li style="margin-bottom: 0.5em;"><code style="background: #f5f5f5; padding: 0.2em 0.5em; border-radius: 3px;">book:start-end</code> for page ranges</li>
                    </ul>

                    <h3 style="margin-top: 1.5em; margin-bottom: 1em; color: var(--text-color);">Examples</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 1em;">
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75em; font-family: monospace; font-size: 0.9em; color: var(--secondary-color);">machine learning,1:42</td>
                                <td style="padding: 0.75em; color: var(--text-color);">Single reference</td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.75em; font-family: monospace; font-size: 0.9em; color: var(--secondary-color);">neural networks,2:15-18,2:25,3:10</td>
                                <td style="padding: 0.75em; color: var(--text-color);">Multiple references</td>
                            </tr>
                            <tr>
                                <td style="padding: 0.75em; font-family: monospace; font-size: 0.9em; color: var(--secondary-color);">deep learning,1:50,1:75-80</td>
                                <td style="padding: 0.75em; color: var(--text-color);">Mixed formats</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCsvHelpModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- AI Help Modal -->
        <div id="aiHelpModal" class="modal">
            <div class="modal-content" style="max-width: 650px;">
                <div class="modal-header">
                    <h2>AI Term Enrichment Help</h2>
                    <button class="modal-close" onclick="closeAiHelpModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1.5em;">Use AI to generate brief descriptions for your index terms. There are two ways to use this feature:</p>

                    <h3 style="margin-top: 0; margin-bottom: 0.75em; color: var(--text-color);">Manual Mode (Recommended)</h3>
                    <p style="margin-bottom: 0.5em;">For users with access to AI chat services like Claude or ChatGPT.</p>
                    <ol style="padding-left: 1.5em; margin-bottom: 1.5em;">
                        <li style="margin-bottom: 0.5em;">Select your AI Provider in <strong>Settings → AI Features</strong></li>
                        <li style="margin-bottom: 0.5em;">Click <strong>Copy AI Prompt</strong> to copy a pre-formatted prompt with your terms</li>
                        <li style="margin-bottom: 0.5em;">Paste the prompt into your AI service (Claude, ChatGPT, etc.)</li>
                        <li style="margin-bottom: 0.5em;">Copy the CSV response from the AI</li>
                        <li style="margin-bottom: 0.5em;">Go to <strong>Tools → Import from CSV → Import Notes</strong></li>
                        <li style="margin-bottom: 0.5em;">Paste the CSV and import the descriptions as notes</li>
                    </ol>

                    <h3 style="margin-top: 1.5em; margin-bottom: 0.75em; color: var(--text-color);">Automatic Mode (API)</h3>
                    <p style="margin-bottom: 0.5em;">For users with API access to Claude or OpenAI.</p>
                    <ol style="padding-left: 1.5em; margin-bottom: 1em;">
                        <li style="margin-bottom: 0.5em;">Go to <strong>Settings → AI Features</strong></li>
                        <li style="margin-bottom: 0.5em;">Select your AI Provider and enter your API key</li>
                        <li style="margin-bottom: 0.5em;">Check <strong>Enable AI features</strong> and save</li>
                        <li style="margin-bottom: 0.5em;">Return here and click <strong>Enrich with API</strong> to automatically generate descriptions</li>
                    </ol>
                    <p style="margin-bottom: 1.5em; font-size: 0.9em; color: var(--secondary-color);">We optimize your API usage by processing terms in bulk and using cost-effective models that deliver great results at lower cost.</p>

                    <p style="margin-top: 1.5em; padding: 0.75em; background: rgba(var(--secondary-color-rgb, 156, 163, 175), 0.1); border-radius: 4px; font-size: 0.9em;">
                        <strong>Tip:</strong> Manual mode is free if you already have a Claude or ChatGPT subscription. API mode requires a separate API subscription with associated costs.
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAiHelpModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Edit Property Modal -->
        <div id="editPropertyModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Edit Custom Property</h2>
                    <button class="modal-close" onclick="closeEditPropertyModal()">&times;</button>
                </div>
                <form id="editPropertyForm" onsubmit="saveEditedProperty(event)">
                    <div class="modal-body">
                        <input type="hidden" id="editPropertyModalId" value="">
                        <div class="form-group">
                            <label for="editPropertyModalName">Custom Property:</label>
                            <input type="text" id="editPropertyModalName" required>
                        </div>
                        <div class="form-group">
                            <label for="editPropertyModalValue">Value:</label>
                            <input type="text" id="editPropertyModalValue" required>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger" onclick="deletePropertyFromModal()">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditPropertyModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Book Property Modal -->
        <div id="editBookPropertyModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Edit Book Metadata</h2>
                    <button class="modal-close" onclick="closeEditBookPropertyModal()">&times;</button>
                </div>
                <form id="editBookPropertyForm" onsubmit="saveEditedBookProperty(event)">
                    <div class="modal-body">
                        <input type="hidden" id="editBookPropertyModalId" value="">
                        <input type="hidden" id="editBookPropertyModalBookNumber" value="">
                        <div class="form-group">
                            <label for="editBookPropertyModalName">Metadata:</label>
                            <input type="text" id="editBookPropertyModalName" required>
                        </div>
                        <div class="form-group">
                            <label for="editBookPropertyModalValue">Value:</label>
                            <input type="text" id="editBookPropertyModalValue" required>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-danger" onclick="deleteBookPropertyFromModal()">Delete</button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditBookPropertyModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Import Index Modal -->
        <div id="importDatabaseModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Import Index</h2>
                    <button class="modal-close" onclick="closeImportDatabaseModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Upload an existing Page Sage index file (.db)</p>
                    <div id="importDatabaseMessage" class="message"></div>
                    <form id="importDatabaseForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="databaseFile">Index File (.db):</label>
                            <input type="file" id="databaseFile" name="file" accept=".db" required>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Import</button>
                            <button type="button" class="btn btn-secondary" onclick="closeImportDatabaseModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Index Modal -->
        <div id="createDatabaseModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Create New Index</h2>
                    <button class="modal-close" onclick="closeCreateDatabaseModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Create a new empty index</p>
                    <div id="createDatabaseMessage" class="message"></div>
                    <form id="createDatabaseForm">
                        <div class="form-group">
                            <label for="newDatabaseName">Index Name:</label>
                            <input type="text" id="newDatabaseName" placeholder="e.g., CFA Level 2" required>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Create</button>
                            <button type="button" class="btn btn-secondary" onclick="closeCreateDatabaseModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Index Modal -->
        <div id="createIndexModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Create New Index</h2>
                    <button class="modal-close" onclick="closeCreateIndexModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="createIndexMessage" class="message"></div>
                    <form id="createIndexForm" onsubmit="submitCreateIndex(event)">
                        <div class="form-group">
                            <label for="createIndexName">Index Name:</label>
                            <input type="text" id="createIndexName" placeholder="e.g., CFA Level 2, GIAC GSEC" required>
                            <small>Give your index a name to identify it</small>
                        </div>

                        <div class="form-group">
                            <label for="createIndexBookName">First Book Name:</label>
                            <input type="text" id="createIndexBookName" placeholder="e.g., Volume 1, Study Guide" required>
                        </div>

                        <div class="get-started-inline-group">
                            <div class="form-group">
                                <label for="createIndexBookNumber">Book Number:</label>
                                <input type="text" id="createIndexBookNumber" value="1" required pattern="[0-9]*" inputmode="numeric">
                            </div>
                            <div class="form-group">
                                <label for="createIndexBookPages">Page Count:</label>
                                <input type="text" id="createIndexBookPages" placeholder="e.g., 500" pattern="[0-9]*" inputmode="numeric">
                            </div>
                        </div>
                        <small style="display: block; margin-bottom: 1em;">Book number is usually "1" for your first book. Page count is optional and used for gap analysis.</small>

                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">Create Index</button>
                            <button type="button" class="btn btn-secondary" onclick="closeCreateIndexModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Get Started Modal -->
        <div id="getStartedModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Welcome to Page Sage</h2>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1.5em;">Let's crush your open book exam. Choose how you would like to get started:</p>

                    <div id="getStartedMessage" class="message"></div>

                    <div class="get-started-options">
                        <!-- Create New Index -->
                        <div class="get-started-option-group">
                            <button type="button" class="btn get-started-btn" onclick="toggleGetStartedSection('create')">Create a new index</button>
                            <div id="getStartedCreateSection" class="get-started-section">
                                <form id="getStartedForm">
                                    <div class="form-group">
                                        <label for="getStartedIndexName">Index Name:</label>
                                        <input type="text" id="getStartedIndexName" placeholder="e.g., CFA Level 2, GIAC GSEC" required>
                                        <small>Give your index a name to identify it</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="getStartedBookName">First Book Name:</label>
                                        <input type="text" id="getStartedBookName" placeholder="e.g., Volume 1, Study Guide" required>
                                    </div>

                                    <div class="get-started-inline-group">
                                        <div class="form-group">
                                            <label for="getStartedBookNumber">Book Number:</label>
                                            <input type="text" id="getStartedBookNumber" value="1" required pattern="[0-9]*" inputmode="numeric">
                                        </div>
                                        <div class="form-group">
                                            <label for="getStartedBookPages">Page Count:</label>
                                            <input type="text" id="getStartedBookPages" placeholder="e.g., 500" pattern="[0-9]*" inputmode="numeric">
                                        </div>
                                    </div>
                                    <small style="display: block; margin-bottom: 1em;">Book number is usually "1" for your first book. Page count is optional and used for gap analysis.</small>

                                    <p style="font-size: 0.9em; color: var(--secondary-color);">
                                        You can change these settings later in the <strong>Settings</strong> section.
                                    </p>

                                    <div class="modal-actions" style="margin-top: 1em;">
                                        <button type="submit" class="btn btn-primary">Create Index</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Import Existing -->
                        <div class="get-started-option-group">
                            <button type="button" class="btn get-started-btn" onclick="toggleGetStartedSection('import')">Import an existing index</button>
                            <div id="getStartedImportSection" class="get-started-section">
                                <p>Import an existing .db index file from your computer.</p>
                                <div class="modal-actions" style="margin-top: 1em;">
                                    <button type="button" class="btn btn-primary" onclick="closeGetStartedModal(); showImportDatabaseModal();">Select File to Import</button>
                                </div>
                            </div>
                        </div>

                        <!-- Demo Index -->
                        <div class="get-started-option-group">
                            <button type="button" class="btn get-started-btn" onclick="toggleGetStartedSection('demo')">Load up a demo index</button>
                            <div id="getStartedDemoSection" class="get-started-section">
                                <p>Load a demo index with sample entries to explore the features.</p>
                                <div class="modal-actions" style="margin-top: 1em;">
                                    <button type="button" class="btn btn-primary" onclick="loadDemoIndex()">Load Demo Index</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <p style="margin: 0; font-size: 0.9em; color: var(--secondary-color);">
                <strong>Page Sage</strong> - Your wise study companion! |
                <a href="https://github.com/iamsgtbaker/PageSage/blob/main/LICENSE" target="_blank" rel="noopener" style="color: var(--secondary-color);">AGPL-3.0 License</a> |
                <a href="https://github.com/iamsgtbaker/PageSage" target="_blank" rel="noopener" style="color: var(--secondary-color);">GitHub</a>
            </p>
        </footer>
        </div>
    </div>

    <!-- Hamburger Menu Panel (outside wrapper to avoid dimming) -->
    <nav id="menu">
        <div class="inner">
            <h2>Page Sage</h2>
            <h3><span id="rotatingTagline">Build your exam reference, fast</span></h3>
            <ul>				
                <!-- Mobile Quick Access (hidden on desktop) -->
                <li class="mobile-only"><a href="#" onclick="menuNavigate('add'); return false;">Add Entry</a></li>
                <li class="mobile-only"><a href="#" onclick="menuNavigate('view'); return false;">View Index</a></li>
                <li class="mobile-only"><a href="#" onclick="menuNavigate('progress'); return false;">My Progress</a></li>
                <li class="mobile-only"><a href="#" onclick="menuNavigate('books'); return false;">Books</a></li>
                <li class="mobile-only"><a href="#" onclick="menuNavigate('tools'); return false;">Tools</a></li>
                <li class="mobile-only"><a href="#" onclick="menuNavigate('settings'); return false;">Settings</a></li>

                <!-- Info links (all devices) -->
                <li><a href="#" onclick="showAboutModal(); return false;">About</a></li>
                <li><a href="#" onclick="showHowToUseModal(); return false;">Getting started</a></li>
                <li><a href="#" onclick="showHelpModal(); return false;">Help</a></li>
                <li><a href="#" onclick="showCliModal(); return false;">CLI Reference</a></li>
                <li><a href="https://github.com/iamsgtbaker/PageSage" target="_blank" rel="noopener">GitHub</a></li>
                <li><a href="https://buymeacoffee.com/iamsgtbaker" title="Did Page Sage help get your exam pass? Show your appreciation by donating a few bucks." target="_blank" rel="noopener">☕ Buy me a coffee</a></li>
            </ul>
        </div>
    </nav>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>